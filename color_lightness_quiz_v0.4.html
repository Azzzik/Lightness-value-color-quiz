<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>Color Lightness Quiz</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; background: #f5f5f5; }
    #color-container { display: flex; gap: 10px; margin-bottom: 1rem; flex-wrap: wrap; }
    .color-block {
      width: 60px;
      height: 60px;
      cursor: grab;
      border: 2px solid #333;
      box-sizing: border-box;
      transition: filter 0.3s ease;
      user-select: none;
    }
    .dragging { opacity: 0.5; }
    button {
      padding: 0.5rem 1rem;
      font-size: 1rem;
      cursor: pointer;
      margin-right: 0.5rem;
      margin-top: 0.5rem;
    }
    #result { margin-top: 1rem; font-size: 1.1rem; }
    #controls { margin-bottom: 1rem; }
    #grayscale-toggle { margin-left: 0.5rem; }
  </style>
</head>
<body>
  <h1>Впорядкуй блоки за Lightness (L)</h1>

  <div id="controls">
    <label>Кількість кольорів:
      <input type="number" id="countInput" value="6" min="3" max="20">
    </label>
    <button id="newGameBtn">Нова гра</button>
    <label>
      <input type="checkbox" id="grayscale-toggle">
      Чорно-білий фільтр
    </label>
  </div>

  <div id="color-container"></div>

  <button id="checkBtn">Перевірити</button>
  <div id="result"></div>

  <script>
    // === Параметри генерації кольорів ===
    const MIN_L = 15;
    const MAX_L = 85;
    const MIN_L_STEP = 8; // Мінімальна різниця між будь-якими двома L

    function randInt(min, maxInclusive) {
      return Math.floor(Math.random() * (maxInclusive - min + 1)) + min;
    }

    function randHSL() {
      const h = randInt(0, 359);
      const s = randInt(40, 90); // 40–90%
      const l = randInt(MIN_L, MAX_L);
      return { h, s, l };
    }

    function generateColors(count) {
      const colors = [];
      let guard = 0;
      while (colors.length < count && guard < 2000) {
        guard++;
        const c = randHSL();
        const ok = colors.every(x => Math.abs(x.l - c.l) >= MIN_L_STEP);
        if (ok) colors.push(c);
      }
      if (colors.length < count) {
        console.warn('Не вдалося згенерувати потрібну кількість з заданим кроком L. Зменш к-сть або крок.');
      }
      // Перемішуємо для випадкового порядку показу
      return shuffle(colors);
    }

    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    // === Стейт гри ===
    let currentColors = []; // [{h,s,l, id}]
    let originalOrder = []; // копія для перевірки

    const container = document.getElementById('color-container');
    const resultBox = document.getElementById('result');
    const checkBtn = document.getElementById('checkBtn');
    const newGameBtn = document.getElementById('newGameBtn');
    const countInput = document.getElementById('countInput');
    const grayscaleToggle = document.getElementById('grayscale-toggle');

    newGameBtn.addEventListener('click', newGame);
    checkBtn.addEventListener('click', checkAnswer);
    grayscaleToggle.addEventListener('change', applyGrayscale);

    function newGame() {
      const count = parseInt(countInput.value, 10) || 6;
      currentColors = generateColors(count).map((c, idx) => ({ ...c, id: idx }));
      originalOrder = [...currentColors].sort((a, b) => a.l - b.l);
      renderBlocks();
      resultBox.textContent = '';
    }

    function hslToCss({h, s, l}) {
      return `hsl(${h} ${s}% ${l}%)`;
    }

    function renderBlocks() {
      container.innerHTML = '';
      currentColors.forEach(c => {
        const div = document.createElement('div');
        div.className = 'color-block';
        div.style.background = hslToCss(c);
        div.draggable = true;
        div.dataset.id = c.id;
        container.appendChild(div);
      });
      initDragAndDrop();
      applyGrayscale();
    }

    function applyGrayscale() {
      const gray = grayscaleToggle.checked;
      [...container.children].forEach(block => {
        block.style.filter = gray ? 'grayscale(100%)' : 'none';
      });
    }

    // === Drag & Drop ===
    function initDragAndDrop() {
      let dragged;

      container.addEventListener('dragstart', e => {
        if (!e.target.classList.contains('color-block')) return;
        dragged = e.target;
        e.target.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
      });

      container.addEventListener('dragend', e => {
        if (!e.target.classList.contains('color-block')) return;
        e.target.classList.remove('dragging');
      });

      container.addEventListener('dragover', e => {
        e.preventDefault();
        const afterEl = getDragAfterElement(container, e.clientX, e.clientY);
        if (afterEl == null) {
          container.appendChild(dragged);
        } else {
          container.insertBefore(dragged, afterEl);
        }
      });
    }

    function getDragAfterElement(container, x, y) {
      const blocks = [...container.querySelectorAll('.color-block:not(.dragging)')];
      return blocks.reduce((closest, child) => {
        const rect = child.getBoundingClientRect();
        const offset = y - rect.top - rect.height / 2;
        if (offset < 0 && offset > closest.offset) {
          return { offset, element: child };
        } else {
          return closest;
        }
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    // === Перевірка ===
    function checkAnswer() {
      const placedIds = [...container.children].map(el => Number(el.dataset.id));
      const placed = placedIds.map(id => currentColors.find(c => c.id === id));
      const correct = originalOrder.map(c => c.id);

      let correctCount = 0;
      placed.forEach((c, i) => {
        if (c.id === correct[i]) correctCount++;
      });

      const percent = Math.round((correctCount / placed.length) * 100);
      resultBox.textContent = `Правильних позицій: ${correctCount}/${placed.length} (${percent}%)`;
    }

    // Стартова гра
    newGame();
  </script>
</body>
</html>
